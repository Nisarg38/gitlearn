# gitlearn v2 - Intelligent PR Insights Extraction
# https://github.com/Nisarg38/gitlearn
#
# Triggers after N merged PRs, uses agentic AI to extract repo-specific insights
#
# Setup:
#   1. Copy this workflow to .github/workflows/gitlearn.yml
#   2. Add API key: gh secret set ANTHROPIC_API_KEY (or OPENAI_API_KEY, OPENROUTER_API_KEY)
#   3. Optionally configure: gh variable set GITLEARN_BATCH_SIZE --body "10"
#
# Default models:
#   Anthropic: claude-sonnet-4-20250514
#   OpenAI: gpt-4o
#   OpenRouter: anthropic/claude-sonnet-4

name: gitlearn

on:
  pull_request:
    types: [closed]
    branches: [main, master]
  workflow_dispatch:
    inputs:
      force_run:
        description: 'Force run regardless of PR count threshold'
        required: false
        default: 'false'
        type: boolean
      bootstrap:
        description: 'Run bootstrap mode (full repo analysis)'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  pull-requests: write

env:
  GITLEARN_BATCH_SIZE: ${{ vars.GITLEARN_BATCH_SIZE || '10' }}
  GITLEARN_MAX_ITERATIONS: ${{ vars.GITLEARN_MAX_ITERATIONS || '50' }}
  GITLEARN_BOOTSTRAP_ITERATIONS: ${{ vars.GITLEARN_BOOTSTRAP_ITERATIONS || '100' }}
  GITLEARN_SKIP_LABELS: ${{ vars.GITLEARN_SKIP_LABELS || 'dependencies,chore' }}
  GITLEARN_REVIEWER: ${{ vars.GITLEARN_REVIEWER }}
  GITLEARN_MODEL: ${{ vars.GITLEARN_MODEL }}

jobs:
  check-threshold:
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.threshold.outputs.should_run }}
      is_bootstrap: ${{ steps.threshold.outputs.is_bootstrap }}
      pr_count: ${{ steps.threshold.outputs.pr_count }}
      pr_numbers: ${{ steps.threshold.outputs.pr_numbers }}
      last_tag: ${{ steps.threshold.outputs.last_tag }}

    steps:
      - name: Check skip labels
        id: skip_check
        if: github.event_name == 'pull_request'
        run: |
          SKIP_LABELS="${{ env.GITLEARN_SKIP_LABELS }}"
          PR_LABELS='${{ toJson(github.event.pull_request.labels.*.name) }}'
          for label in ${SKIP_LABELS//,/ }; do
            if echo "$PR_LABELS" | grep -qi "\"$label\""; then
              echo "skip=true" >> $GITHUB_OUTPUT
              echo "Skipping - PR has label: $label"
              exit 0
            fi
          done
          echo "skip=false" >> $GITHUB_OUTPUT

      - uses: actions/checkout@v4
        if: steps.skip_check.outputs.skip != 'true'
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Check threshold
        if: steps.skip_check.outputs.skip != 'true'
        id: threshold
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check for bootstrap mode
          if [ "${{ github.event.inputs.bootstrap }}" = "true" ]; then
            echo "Bootstrap mode requested via workflow_dispatch"
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "is_bootstrap=true" >> $GITHUB_OUTPUT
            echo "pr_count=0" >> $GITHUB_OUTPUT
            echo "pr_numbers=" >> $GITHUB_OUTPUT
            echo "last_tag=" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Find last gitlearn run tag
          LAST_TAG=$(git tag -l "gitlearn-run-*" --sort=-version:refname | head -1)
          echo "last_tag=$LAST_TAG" >> $GITHUB_OUTPUT

          # Check if this is first run (bootstrap)
          if [ -z "$LAST_TAG" ]; then
            echo "No gitlearn tags found - this is a bootstrap run"
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "is_bootstrap=true" >> $GITHUB_OUTPUT
            echo "pr_count=0" >> $GITHUB_OUTPUT
            echo "pr_numbers=" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Last gitlearn tag: $LAST_TAG"

          # Get timestamp of last tag
          TAG_DATE=$(git log -1 --format=%cI "$LAST_TAG" 2>/dev/null || echo "")
          if [ -z "$TAG_DATE" ]; then
            echo "Could not get tag date, treating as bootstrap"
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "is_bootstrap=true" >> $GITHUB_OUTPUT
            echo "pr_count=0" >> $GITHUB_OUTPUT
            echo "pr_numbers=" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Tag date: $TAG_DATE"

          # Get merged PRs since last tag (excluding skip labels)
          SKIP_LABELS="${{ env.GITLEARN_SKIP_LABELS }}"

          PRS=$(gh pr list --state merged --search "merged:>=$TAG_DATE" --json number,title,labels --limit 100)

          # Filter out PRs with skip labels
          FILTERED_PRS=$(echo "$PRS" | jq -c --arg skip "$SKIP_LABELS" '
            [.[] | select(
              .labels as $labels |
              ($skip | split(",")) as $skipList |
              ([$labels[].name] | map(. as $l | $skipList | map(. == $l) | any) | any) | not
            )]
          ')

          PR_COUNT=$(echo "$FILTERED_PRS" | jq 'length')
          PR_NUMBERS=$(echo "$FILTERED_PRS" | jq -r '[.[].number] | join(",")')

          echo "Merged PRs since last run: $PR_COUNT"
          echo "PR numbers: $PR_NUMBERS"
          echo "pr_count=$PR_COUNT" >> $GITHUB_OUTPUT
          echo "pr_numbers=$PR_NUMBERS" >> $GITHUB_OUTPUT
          echo "is_bootstrap=false" >> $GITHUB_OUTPUT

          # Check threshold
          BATCH_SIZE="${{ env.GITLEARN_BATCH_SIZE }}"

          if [ "${{ github.event.inputs.force_run }}" = "true" ]; then
            echo "Force run requested"
            echo "should_run=true" >> $GITHUB_OUTPUT
          elif [ "$PR_COUNT" -ge "$BATCH_SIZE" ]; then
            echo "Threshold met: $PR_COUNT >= $BATCH_SIZE"
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "Threshold not met: $PR_COUNT < $BATCH_SIZE"
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

      - name: Summary (threshold not met)
        if: steps.skip_check.outputs.skip != 'true' && steps.threshold.outputs.should_run != 'true'
        run: |
          echo "### ðŸ“Š gitlearn" >> $GITHUB_STEP_SUMMARY
          echo "Threshold not met: ${{ steps.threshold.outputs.pr_count }}/${{ env.GITLEARN_BATCH_SIZE }} PRs" >> $GITHUB_STEP_SUMMARY
          echo "Next run after ${{ env.GITLEARN_BATCH_SIZE }} merged PRs since last tag." >> $GITHUB_STEP_SUMMARY

  extract-insights:
    needs: check-threshold
    if: needs.check-threshold.outputs.should_run == 'true'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Configure provider
        id: config
        run: |
          if [ -n "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
            echo "provider=anthropic" >> $GITHUB_OUTPUT
            echo "model=${GITLEARN_MODEL:-anthropic/claude-sonnet-4-20250514}" >> $GITHUB_OUTPUT
            echo "api_key_var=ANTHROPIC_API_KEY" >> $GITHUB_OUTPUT
          elif [ -n "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "provider=openai" >> $GITHUB_OUTPUT
            echo "model=${GITLEARN_MODEL:-openai/gpt-4o}" >> $GITHUB_OUTPUT
            echo "api_key_var=OPENAI_API_KEY" >> $GITHUB_OUTPUT
          elif [ -n "${{ secrets.OPENROUTER_API_KEY }}" ]; then
            echo "provider=openrouter" >> $GITHUB_OUTPUT
            echo "model=${GITLEARN_MODEL:-openrouter/anthropic/claude-sonnet-4}" >> $GITHUB_OUTPUT
            echo "api_key_var=OPENROUTER_API_KEY" >> $GITHUB_OUTPUT
          else
            echo "::error::No API key found. Add ANTHROPIC_API_KEY, OPENAI_API_KEY, or OPENROUTER_API_KEY"
            exit 1
          fi

      - name: Setup context files (symlink)
        id: setup
        run: |
          # Handle claude.md and agents.md symlink setup
          if [ ! -f claude.md ] && [ ! -f agents.md ]; then
            # Case 1: Neither exists - create template
            echo "Creating initial claude.md with template"
            cat > claude.md << 'TEMPLATE'
          # Project Context

          > Auto-maintained by [gitlearn](https://github.com/Nisarg38/gitlearn).
          > Human-reviewed before merge.

          <!-- gitlearn:meta
          last_run: never
          -->

          ## Architecture

          <!-- System design, key patterns, data flow -->

          ## Business Logic

          <!-- Domain-specific rules, workflows, constraints -->

          ## Conventions

          <!-- Team standards, naming patterns, file organization -->

          ## Gotchas & Warnings

          <!-- Non-obvious behaviors, common mistakes -->

          ## Tools & Dependencies

          <!-- Non-standard library usage, configuration patterns -->

          ---

          ## Changelog

          <!-- Recent updates -->
          TEMPLATE
            ln -s claude.md agents.md
            echo "created=true" >> $GITHUB_OUTPUT

          elif [ ! -f claude.md ] && [ -f agents.md ] && [ ! -L agents.md ]; then
            # Case 3: Only agents.md exists as regular file
            echo "Moving agents.md to claude.md"
            mv agents.md claude.md
            ln -s claude.md agents.md
            echo "created=true" >> $GITHUB_OUTPUT

          elif [ -f claude.md ] && [ -f agents.md ] && [ ! -L agents.md ]; then
            # Case 4: Both exist as regular files - need merge
            echo "Both files exist, will merge"
            echo "needs_merge=true" >> $GITHUB_OUTPUT

          elif [ -f claude.md ] && [ ! -e agents.md ]; then
            # Case 2: Only claude.md exists
            echo "Creating agents.md symlink"
            ln -s claude.md agents.md
            echo "created=true" >> $GITHUB_OUTPUT

          else
            # Case 5: Already properly set up
            echo "Context files already configured"
            echo "created=false" >> $GITHUB_OUTPUT
          fi

      - name: Install OpenCode
        run: |
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH

      - name: Collect PR data
        if: needs.check-threshold.outputs.is_bootstrap != 'true'
        id: collect
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBERS="${{ needs.check-threshold.outputs.pr_numbers }}"

          if [ -z "$PR_NUMBERS" ]; then
            echo "No PRs to process"
            echo "pr_data=" >> $GITHUB_OUTPUT
            exit 0
          fi

          PR_DATA=""

          for PR_NUM in ${PR_NUMBERS//,/ }; do
            echo "Collecting data for PR #$PR_NUM..."

            # Get PR metadata
            PR_INFO=$(gh pr view "$PR_NUM" --json title,body,author,mergedAt)
            TITLE=$(echo "$PR_INFO" | jq -r '.title')
            BODY=$(echo "$PR_INFO" | jq -r '.body // "No description"' | head -c 2000)
            AUTHOR=$(echo "$PR_INFO" | jq -r '.author.login')
            MERGED_AT=$(echo "$PR_INFO" | jq -r '.mergedAt')

            # Get PR diff (truncated)
            DIFF=$(gh pr diff "$PR_NUM" 2>/dev/null | head -c 10000 || echo "Diff unavailable")

            # Get PR comments
            COMMENTS=$(gh api "repos/${{ github.repository }}/issues/$PR_NUM/comments" --jq '.[].body' 2>/dev/null | head -c 1000 || echo "")

            # Get review comments
            REVIEWS=$(gh api "repos/${{ github.repository }}/pulls/$PR_NUM/comments" --jq '.[].body' 2>/dev/null | head -c 1000 || echo "")

            PR_DATA="$PR_DATA
          ---

          ## PR #$PR_NUM: $TITLE

          **Author:** $AUTHOR
          **Merged:** $MERGED_AT

          ### Description
          $BODY

          ### Discussion
          $COMMENTS
          $REVIEWS

          ### Changes
          \`\`\`diff
          $DIFF
          \`\`\`
          "
          done

          # Write to file to avoid shell escaping issues
          echo "$PR_DATA" > /tmp/pr_data.md
          echo "pr_data_file=/tmp/pr_data.md" >> $GITHUB_OUTPUT

      - name: Prepare agent prompt
        id: prompt
        run: |
          IS_BOOTSTRAP="${{ needs.check-threshold.outputs.is_bootstrap }}"
          PR_COUNT="${{ needs.check-threshold.outputs.pr_count }}"

          if [ "$IS_BOOTSTRAP" = "true" ]; then
            MAX_ITER="${{ env.GITLEARN_BOOTSTRAP_ITERATIONS }}"
            PROMPT_TYPE="bootstrap"
          else
            MAX_ITER="${{ env.GITLEARN_MAX_ITERATIONS }}"
            PROMPT_TYPE="regular"
          fi

          echo "max_iterations=$MAX_ITER" >> $GITHUB_OUTPUT
          echo "prompt_type=$PROMPT_TYPE" >> $GITHUB_OUTPUT

      - name: Run OpenCode agent (Bootstrap)
        if: needs.check-threshold.outputs.is_bootstrap == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          opencode run --model "${{ steps.config.outputs.model }}" "
          # gitlearn Bootstrap Analysis

          You are gitlearn, an AI that maintains repository context files. This is the FIRST run on this repository - perform a comprehensive analysis.

          ## Your Mission
          Analyze this entire codebase and create meaningful documentation in claude.md that would help a developer (or AI assistant) unfamiliar with this repository.

          ## Process

          1. **Explore the codebase structure**
             - List directories and understand the organization
             - Read key files: README, package.json/pyproject.toml/go.mod, main entry points
             - Identify the tech stack and frameworks

          2. **Identify patterns and architecture**
             - How is the code organized?
             - What are the main components/modules?
             - How do they interact?

          3. **Document repo-specific insights**
             Focus ONLY on things specific to THIS repo:
             - Business logic rules (domain-specific)
             - Architectural decisions (and their rationale if visible)
             - Team conventions (not obvious from code alone)
             - Gotchas and warnings (things that will trip people up)
             - Tool/library usage patterns (non-standard configurations)

          4. **Update claude.md**
             - Read the existing template in claude.md
             - Fill in each section with discovered insights
             - Update the gitlearn:meta comment with current timestamp
             - Keep it concise - quality over quantity

          ## What to SKIP
          - Common knowledge (everyone knows React uses components)
          - Generic best practices (use meaningful variable names)
          - Obvious patterns (API routes in /api folder)
          - Version numbers and dependencies (unless usage is non-obvious)

          ## Important
          - Make changes directly to claude.md
          - Do NOT modify agents.md - it's a symlink to claude.md
          - Be thorough but concise
          "

      - name: Run OpenCode agent (PR Analysis)
        if: needs.check-threshold.outputs.is_bootstrap != 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          PR_DATA=$(cat /tmp/pr_data.md)

          opencode run --model "${{ steps.config.outputs.model }}" "
          # gitlearn PR Analysis

          You are gitlearn, an AI that maintains repository context files.

          ## Your Mission
          Analyze the recent merged PRs and update claude.md with insights that would help a developer (or AI assistant) unfamiliar with this codebase.

          ## PRs to Analyze
          $PR_DATA

          ## Process

          1. **Read existing context**
             - Open and read claude.md to understand what's already documented
             - Note existing sections and content

          2. **Analyze each PR deeply**
             - Read the diff to see what changed
             - Explore related files in the codebase to understand WHY
             - Consider the PR description and discussion comments
             - Look for patterns, decisions, conventions

          3. **Extract valuable insights**
             Focus ONLY on things specific to THIS repo:
             - Business logic rules (domain-specific)
             - Architectural decisions (and their rationale)
             - Team conventions (not obvious from code alone)
             - Gotchas and warnings (things that will trip people up)
             - Tool/library usage patterns (non-standard configurations)

          4. **Update claude.md intelligently**
             - Add new insights under appropriate sections
             - Deduplicate - don't repeat what's already documented
             - Update outdated info if code has changed
             - Reorganize if content is in wrong section
             - Update the gitlearn:meta comment with current timestamp
             - Add entry to Changelog section with PR numbers
             - Keep it concise - quality over quantity

          ## What to SKIP
          - Common knowledge (everyone knows React uses components)
          - Generic best practices (use meaningful variable names)
          - Obvious patterns (API routes in /api folder)
          - Bug fixes without architectural significance
          - Typo corrections or minor refactors

          ## Important
          - Make changes directly to claude.md
          - Do NOT modify agents.md - it's a symlink to claude.md
          - If no meaningful insights from the PRs, just update the meta timestamp
          "

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet claude.md; then
            echo "No changes to claude.md"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected in claude.md"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Create git tag
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          TAG_NAME="gitlearn-run-$(date +%Y%m%d-%H%M%S)"
          git tag "$TAG_NAME"
          echo "Created tag: $TAG_NAME"
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV

      - name: Commit and push
        if: steps.changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "gitlearn[bot]"
          git config user.email "gitlearn[bot]@users.noreply.github.com"

          # Check for existing open gitlearn PR
          EXISTING_PR=$(gh pr list --state open --label "gitlearn" --json number,headRefName --jq '.[0].headRefName // empty')

          if [ -n "$EXISTING_PR" ]; then
            echo "Found existing gitlearn PR branch: $EXISTING_PR"
            BRANCH="$EXISTING_PR"
            git fetch origin "$BRANCH"
            git checkout "$BRANCH"
            git pull origin "$BRANCH" --rebase || git pull origin "$BRANCH"
          else
            echo "Creating new branch"
            BRANCH="gitlearn/insights-$(date +%Y%m%d)"
            git checkout -b "$BRANCH"
          fi

          # Stage and commit
          git add claude.md agents.md

          IS_BOOTSTRAP="${{ needs.check-threshold.outputs.is_bootstrap }}"
          PR_NUMBERS="${{ needs.check-threshold.outputs.pr_numbers }}"

          if [ "$IS_BOOTSTRAP" = "true" ]; then
            COMMIT_MSG="ðŸš€ gitlearn: Bootstrap repository context"
          else
            COMMIT_MSG="ðŸ“š gitlearn: Extract insights from PRs #${PR_NUMBERS//,/, #}"
          fi

          git commit -m "$COMMIT_MSG" || {
            echo "No changes to commit"
            exit 0
          }

          # Push branch and tag
          git push origin "$BRANCH" -u || git push origin "$BRANCH" --force-with-lease
          git push origin "$TAG_NAME"

          echo "BRANCH=$BRANCH" >> $GITHUB_ENV

      - name: Create or update PR
        if: steps.changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          IS_BOOTSTRAP="${{ needs.check-threshold.outputs.is_bootstrap }}"
          PR_NUMBERS="${{ needs.check-threshold.outputs.pr_numbers }}"
          PR_COUNT="${{ needs.check-threshold.outputs.pr_count }}"

          # Check if PR already exists for this branch
          EXISTING_PR_NUM=$(gh pr list --head "$BRANCH" --state open --json number --jq '.[0].number // empty')

          if [ -n "$EXISTING_PR_NUM" ]; then
            echo "PR #$EXISTING_PR_NUM already exists, it will be updated automatically"

            # Add reviewer if configured
            if [ -n "${{ env.GITLEARN_REVIEWER }}" ]; then
              gh pr edit "$EXISTING_PR_NUM" --add-reviewer "${{ env.GITLEARN_REVIEWER }}" 2>/dev/null || true
            fi

            # Update PR body with new info
            if [ "$IS_BOOTSTRAP" = "true" ]; then
              BODY="Bootstrap analysis added to context files."
            else
              BODY="Added insights from PRs: #${PR_NUMBERS//,/, #}"
            fi
            gh pr comment "$EXISTING_PR_NUM" --body "$BODY"

            PR_URL=$(gh pr view "$EXISTING_PR_NUM" --json url --jq '.url')
          else
            # Create new PR
            if [ "$IS_BOOTSTRAP" = "true" ]; then
              TITLE="ðŸš€ gitlearn: Bootstrap Repository Context"
              BODY="## Bootstrap Analysis

          gitlearn has performed an initial analysis of this repository and created context documentation.

          **What's included:**
          - Architecture overview
          - Business logic patterns
          - Team conventions
          - Potential gotchas

          Please review and merge when satisfied."
            else
              TITLE="ðŸ¤– gitlearn: Context Updates"
              BODY="## Context Updates

          gitlearn has extracted insights from recent merged PRs.

          **PRs analyzed:** #${PR_NUMBERS//,/, #}
          **Total:** $PR_COUNT PRs

          Please review the changes to \`claude.md\` and merge when satisfied."
            fi

            REVIEWER_FLAG=""
            if [ -n "${{ env.GITLEARN_REVIEWER }}" ]; then
              REVIEWER_FLAG="--reviewer ${{ env.GITLEARN_REVIEWER }}"
            fi

            PR_URL=$(gh pr create \
              --title "$TITLE" \
              --body "$BODY" \
              --head "$BRANCH" \
              --base main \
              --label "gitlearn" \
              $REVIEWER_FLAG 2>/dev/null || \
              gh pr create --title "$TITLE" --body "$BODY" --head "$BRANCH" --base main)
          fi

          echo "PR_URL=$PR_URL" >> $GITHUB_ENV

      - name: Summary
        if: always()
        run: |
          IS_BOOTSTRAP="${{ needs.check-threshold.outputs.is_bootstrap }}"
          PR_COUNT="${{ needs.check-threshold.outputs.pr_count }}"
          PR_NUMBERS="${{ needs.check-threshold.outputs.pr_numbers }}"
          HAS_CHANGES="${{ steps.changes.outputs.has_changes }}"

          echo "### ðŸ“š gitlearn" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$IS_BOOTSTRAP" = "true" ]; then
            echo "**Mode:** Bootstrap (initial repository analysis)" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Mode:** PR Analysis" >> $GITHUB_STEP_SUMMARY
            echo "**PRs analyzed:** $PR_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "**PR numbers:** #${PR_NUMBERS//,/, #}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$HAS_CHANGES" = "true" ]; then
            echo "**Status:** âœ… Context updated" >> $GITHUB_STEP_SUMMARY
            echo "**Tag:** \`$TAG_NAME\`" >> $GITHUB_STEP_SUMMARY
            if [ -n "$PR_URL" ]; then
              echo "**PR:** $PR_URL" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "**Status:** â„¹ï¸ No meaningful insights extracted" >> $GITHUB_STEP_SUMMARY
          fi
