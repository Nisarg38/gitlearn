# gitlearn - Learn from merged PRs and keep AI context files fresh
# https://github.com/Nisarg38/gitlearn
#
# Setup:
#   mkdir -p .github/workflows && curl -o .github/workflows/gitlearn.yml https://raw.githubusercontent.com/Nisarg38/gitlearn/main/.github/workflows/gitlearn.yml
#   gh secret set ANTHROPIC_API_KEY  # or OPENAI_API_KEY, OPENROUTER_API_KEY
#
# Default models:
#   Anthropic: claude-sonnet-4-5-20250929 (extended thinking)
#   OpenAI: gpt-5.2-codex
#   OpenRouter: moonshotai/kimi-k2.5
#
# Configuration (repository variables):
#   GITLEARN_MODEL: Override model
#   GITLEARN_MAX_TOKENS: Max output tokens (default: 1024)
#   GITLEARN_THINKING_BUDGET: Claude thinking tokens (default: 10000, set to 0 to disable)
#   GITLEARN_API_BASE: Custom OpenAI-compatible endpoint
#   GITLEARN_SKIP_LABELS: Comma-separated labels to skip (default: dependencies,chore)

name: gitlearn

on:
  pull_request:
    types: [closed]
    branches: [main, master]

jobs:
  learn:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    env:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
      GITLEARN_MODEL: ${{ vars.GITLEARN_MODEL }}
      GITLEARN_MAX_TOKENS: ${{ vars.GITLEARN_MAX_TOKENS }}
      GITLEARN_THINKING_BUDGET: ${{ vars.GITLEARN_THINKING_BUDGET }}
      GITLEARN_API_BASE: ${{ vars.GITLEARN_API_BASE }}
      GITLEARN_SKIP_LABELS: ${{ vars.GITLEARN_SKIP_LABELS }}

    steps:
      - name: Check skip labels
        id: skip
        run: |
          SKIP_LABELS="${GITLEARN_SKIP_LABELS:-dependencies,chore}"
          PR_LABELS='${{ toJson(github.event.pull_request.labels.*.name) }}'

          for label in ${SKIP_LABELS//,/ }; do
            if echo "$PR_LABELS" | grep -qi "\"$label\""; then
              echo "Skipping: PR has label '$label'"
              echo "skip=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          done
          echo "skip=false" >> $GITHUB_OUTPUT

      - uses: actions/checkout@v4
        if: steps.skip.outputs.skip != 'true'
        with:
          fetch-depth: 0

      - name: Configure
        if: steps.skip.outputs.skip != 'true'
        id: config
        run: |
          # Detect provider and set defaults
          if [ -n "$GITLEARN_API_BASE" ]; then
            PROVIDER="custom"
            API_KEY="${OPENAI_API_KEY:-${ANTHROPIC_API_KEY:-$OPENROUTER_API_KEY}}"
            MODEL="${GITLEARN_MODEL:-gpt-4o}"
            THINKING=""
          elif [ -n "$ANTHROPIC_API_KEY" ]; then
            PROVIDER="anthropic"
            API_KEY="$ANTHROPIC_API_KEY"
            MODEL="${GITLEARN_MODEL:-claude-sonnet-4-5-20250929}"
            THINKING="${GITLEARN_THINKING_BUDGET:-10000}"
          elif [ -n "$OPENAI_API_KEY" ]; then
            PROVIDER="openai"
            API_KEY="$OPENAI_API_KEY"
            MODEL="${GITLEARN_MODEL:-gpt-5.2-codex}"
            THINKING=""
          elif [ -n "$OPENROUTER_API_KEY" ]; then
            PROVIDER="openrouter"
            API_KEY="$OPENROUTER_API_KEY"
            MODEL="${GITLEARN_MODEL:-moonshotai/kimi-k2.5}"
            THINKING=""
          else
            echo "::error::No API key found. Add ANTHROPIC_API_KEY, OPENAI_API_KEY, or OPENROUTER_API_KEY"
            exit 1
          fi

          # Export to env file (more secure than GITHUB_OUTPUT for secrets)
          echo "PROVIDER=$PROVIDER" >> $GITHUB_ENV
          echo "MODEL=$MODEL" >> $GITHUB_ENV
          echo "THINKING=$THINKING" >> $GITHUB_ENV
          echo "MAX_TOKENS=${GITLEARN_MAX_TOKENS:-1024}" >> $GITHUB_ENV

          # Mask and export API key
          echo "::add-mask::$API_KEY"
          echo "API_KEY=$API_KEY" >> $GITHUB_ENV

          echo "Using $PROVIDER with $MODEL"

      - name: Setup context files
        if: steps.skip.outputs.skip != 'true'
        id: setup
        run: |
          if [ ! -f claude.md ] && [ ! -f agents.md ]; then
            cat > claude.md << 'EOF'
# Project Context

## Overview
<!-- Add project description -->

## Learnings
EOF
            ln -s claude.md agents.md
            echo "changes=true" >> $GITHUB_OUTPUT
          elif [ ! -f claude.md ] && [ -f agents.md ]; then
            mv agents.md claude.md
            ln -s claude.md agents.md
            echo "changes=true" >> $GITHUB_OUTPUT
          elif [ -f agents.md ] && [ ! -L agents.md ]; then
            echo "merge=true" >> $GITHUB_OUTPUT
          elif [ ! -e agents.md ]; then
            ln -s claude.md agents.md
            echo "changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Merge existing files
        if: steps.skip.outputs.skip != 'true' && steps.setup.outputs.merge == 'true'
        run: |
          PROMPT="Merge these AI context files. Dedupe, preserve all unique info.

FILE 1 (claude.md):
$(cat claude.md)

FILE 2 (agents.md):
$(cat agents.md)

Output only the merged markdown."

          if [ "$PROVIDER" = "anthropic" ]; then
            REQUEST=$(jq -n --arg m "$MODEL" --arg p "$PROMPT" '{model:$m,max_tokens:4096,messages:[{role:"user",content:$p}]}')
            RESULT=$(curl -sf https://api.anthropic.com/v1/messages \
              -H "x-api-key: $API_KEY" -H "anthropic-version: 2023-06-01" -H "content-type: application/json" \
              -d "$REQUEST" | jq -r '.content | map(select(.type=="text")) | .[0].text // empty')
          else
            case "$PROVIDER" in
              openai) EP="https://api.openai.com/v1/chat/completions" ;;
              openrouter) EP="https://openrouter.ai/api/v1/chat/completions" ;;
              custom) EP="${GITLEARN_API_BASE}/chat/completions" ;;
            esac
            REQUEST=$(jq -n --arg m "$MODEL" --arg p "$PROMPT" '{model:$m,max_tokens:4096,messages:[{role:"user",content:$p}]}')
            RESULT=$(curl -sf "$EP" -H "Authorization: Bearer $API_KEY" -H "Content-Type: application/json" \
              -d "$REQUEST" | jq -r '.choices[0].message.content // empty')
          fi

          [ -n "$RESULT" ] && echo "$RESULT" > claude.md
          rm -f agents.md && ln -s claude.md agents.md

      - name: Generate learning
        if: steps.skip.outputs.skip != 'true'
        id: learn
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_DIFF=$(gh pr diff ${{ github.event.pull_request.number }} --repo ${{ github.repository }} 2>/dev/null | head -c 10000 || echo "")

          PROMPT="Based on this merged PR, suggest a 1-3 line addition for the project AI context file.

Focus on: architectural decisions, conventions, gotchas, dependencies.

Output ONLY the markdown to append, or NONE if nothing worth documenting.

PR: ${{ github.event.pull_request.title }}
Description: ${{ github.event.pull_request.body }}
Diff:
$PR_DIFF"

          # Call API based on provider
          if [ "$PROVIDER" = "anthropic" ]; then
            if [ -n "$THINKING" ] && [ "$THINKING" != "0" ]; then
              REQUEST=$(jq -n --arg m "$MODEL" --arg p "$PROMPT" --argjson t "$THINKING" \
                '{model:$m,max_tokens:16384,thinking:{type:"enabled",budget_tokens:$t},messages:[{role:"user",content:$p}]}')
            else
              REQUEST=$(jq -n --arg m "$MODEL" --arg p "$PROMPT" --argjson mt "$MAX_TOKENS" \
                '{model:$m,max_tokens:$mt,messages:[{role:"user",content:$p}]}')
            fi

            RESPONSE=$(curl -sf https://api.anthropic.com/v1/messages \
              -H "x-api-key: $API_KEY" \
              -H "anthropic-version: 2023-06-01" \
              -H "content-type: application/json" \
              -d "$REQUEST" 2>&1) || { echo "::error::Anthropic API failed: $RESPONSE"; exit 1; }

            SUGGESTION=$(echo "$RESPONSE" | jq -r '.content | map(select(.type=="text")) | .[0].text // "NONE"')
          else
            case "$PROVIDER" in
              openai) ENDPOINT="https://api.openai.com/v1/chat/completions" ;;
              openrouter) ENDPOINT="https://openrouter.ai/api/v1/chat/completions" ;;
              custom) ENDPOINT="${GITLEARN_API_BASE}/chat/completions" ;;
            esac

            REQUEST=$(jq -n --arg m "$MODEL" --arg p "$PROMPT" --argjson mt "$MAX_TOKENS" \
              '{model:$m,max_tokens:$mt,messages:[{role:"user",content:$p}]}')

            RESPONSE=$(curl -sf "$ENDPOINT" \
              -H "Authorization: Bearer $API_KEY" \
              -H "Content-Type: application/json" \
              -H "HTTP-Referer: https://github.com/${{ github.repository }}" \
              -d "$REQUEST" 2>&1) || { echo "::error::API failed: $RESPONSE"; exit 1; }

            SUGGESTION=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // "NONE"')
          fi

          [ -z "$SUGGESTION" ] && SUGGESTION="NONE"

          echo "suggestion<<EOF" >> $GITHUB_OUTPUT
          echo "$SUGGESTION" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update context PR
        if: steps.skip.outputs.skip != 'true' && steps.learn.outputs.suggestion != 'NONE' && !contains(steps.learn.outputs.suggestion, 'NONE')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="gitlearn/context-updates"
          git config user.name "gitlearn[bot]"
          git config user.email "gitlearn[bot]@users.noreply.github.com"

          if git ls-remote --exit-code --heads origin $BRANCH 2>/dev/null; then
            git fetch origin $BRANCH
            git checkout $BRANCH
            git rebase origin/main 2>/dev/null || git reset --hard origin/main
          else
            git checkout -b $BRANCH
          fi

          [ "${{ steps.setup.outputs.changes }}" = "true" ] || [ "${{ steps.setup.outputs.merge }}" = "true" ] && git add claude.md agents.md 2>/dev/null || true

          echo "" >> claude.md
          echo "<!-- PR #${{ github.event.pull_request.number }} -->" >> claude.md
          echo '${{ steps.learn.outputs.suggestion }}' >> claude.md

          git add claude.md agents.md
          git commit -m "ðŸ“š #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}" || exit 0
          git push origin $BRANCH --force-with-lease

          gh pr list --head $BRANCH --state open --json number | jq -e '.[0]' >/dev/null 2>&1 || \
            gh pr create --title "ðŸ¤– Context Updates" \
              --body "Auto-accumulated learnings from merged PRs. Review and merge when ready." \
              --head $BRANCH --base main --label "gitlearn" 2>/dev/null || \
            gh pr create --title "ðŸ¤– Context Updates" --body "Auto-accumulated learnings." --head $BRANCH --base main
